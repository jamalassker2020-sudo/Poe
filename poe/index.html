<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Symbol Scalper Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --bg-card-hover: #222d3f;
            --text-primary: #f0f4f8;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #00d4aa;
            --accent-glow: rgba(0, 212, 170, 0.3);
            --profit: #10b981;
            --profit-bg: rgba(16, 185, 129, 0.15);
            --loss: #ef4444;
            --loss-bg: rgba(239, 68, 68, 0.15);
            --warning: #f59e0b;
            --border: #2a3548;
            --chart-line: #3b82f6;
        }

        .light {
            --bg-primary: #f1f5f9;
            --bg-secondary: #e2e8f0;
            --bg-card: #ffffff;
            --bg-card-hover: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --accent: #059669;
            --accent-glow: rgba(5, 150, 105, 0.2);
            --border: #cbd5e1;
            --chart-line: #2563eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 12px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            background: var(--bg-card);
            border-radius: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--accent), #00a080);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo h1 {
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo span {
            color: var(--accent);
        }

        .logo .subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-badge.connected .status-dot {
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent);
            animation: pulse 2s infinite;
        }

        .status-badge.running .status-dot {
            background: var(--profit);
            box-shadow: 0 0 10px var(--profit);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px 14px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .stat-value.profit { color: var(--profit); }
        .stat-value.loss { color: var(--loss); }
        .stat-value.accent { color: var(--accent); }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 12px;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Symbols Panel */
        .symbols-panel {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .panel-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .panel-header .badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            background: var(--accent-glow);
            color: var(--accent);
            border-radius: 10px;
            font-weight: 600;
        }

        .symbols-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 400px;
            overflow-y: auto;
        }

        .symbol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .symbol-item.active {
            border-color: var(--accent);
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .symbol-item.has-trade {
            background: var(--profit-bg);
            border-color: var(--profit);
        }

        .symbol-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .symbol-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .symbol-vol {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .symbol-price {
            text-align: right;
        }

        .symbol-price .price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .symbol-price .change {
            font-size: 0.7rem;
            font-weight: 500;
        }

        .symbol-price .change.up { color: var(--profit); }
        .symbol-price .change.down { color: var(--loss); }

        /* Active Trades Panel */
        .trades-panel {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .active-trades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 10px;
            max-height: 420px;
            overflow-y: auto;
        }

        .trade-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--border);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .trade-card.profit {
            border-color: var(--profit);
            background: var(--profit-bg);
        }

        .trade-card.loss {
            border-color: var(--loss);
            background: var(--loss-bg);
        }

        .trade-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .trade-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent);
        }

        .trade-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            font-weight: 700;
        }

        .trade-pnl.profit { color: var(--profit); }
        .trade-pnl.loss { color: var(--loss); }

        .trade-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .trade-detail {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .trade-detail label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .trade-detail value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .trade-progress {
            margin-top: 10px;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .trade-progress-fill {
            height: 100%;
            width: 50%;
            background: var(--text-muted);
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .trade-progress-fill.profit { background: var(--profit); }
        .trade-progress-fill.loss { background: var(--loss); }

        .no-trades {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .no-trades svg {
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
            opacity: 0.4;
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Controls */
        .controls {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .control-group.full {
            grid-column: span 2;
        }

        .control-group label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .control-group input, .control-group select {
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-start {
            background: linear-gradient(135deg, var(--accent), #00a080);
            color: #000;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--accent-glow);
        }

        .btn-stop {
            background: var(--loss);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Trade History */
        .trade-history {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid var(--border);
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .trades-scroll {
            flex: 1;
            overflow-y: auto;
            max-height: 250px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 6px;
            border-left: 3px solid transparent;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .history-item.win { border-left-color: var(--profit); }
        .history-item.loss { border-left-color: var(--loss); }

        .history-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 6px;
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .history-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .history-info .num {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .history-info .time {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .history-right {
            text-align: right;
        }

        .history-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .history-pnl.profit { color: var(--profit); }
        .history-pnl.loss { color: var(--loss); }

        .history-duration {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* Log */
        .log-panel {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 14px;
            border: 1px solid var(--border);
            margin-top: 12px;
        }

        .log-entries {
            height: 100px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 10px;
        }

        .log-entry {
            margin-bottom: 3px;
            line-height: 1.5;
        }

        .log-entry .time { color: var(--text-muted); }
        .log-entry.info { color: var(--text-secondary); }
        .log-entry.success { color: var(--profit); }
        .log-entry.error { color: var(--loss); }
        .log-entry.trade { color: var(--accent); }
        .log-entry.warn { color: var(--warning); }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 23, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .hidden { display: none !important; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        @media (max-width: 600px) {
            .header { flex-direction: column; gap: 10px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .control-row { grid-template-columns: 1fr; }
            .control-group.full { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Fetching top volatile pairs...</div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div>
                    <h1>Multi<span>Scalper</span></h1>
                    <div class="subtitle">Top 10 Volatile Pairs</div>
                </div>
            </div>
            <div class="header-right">
                <div class="status-badge" id="statusBadge">
                    <div class="status-dot"></div>
                    <span id="statusText">Ready</span>
                </div>
            </div>
        </header>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Balance</div>
                <div class="stat-value" id="balance">$100.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total P&L</div>
                <div class="stat-value" id="totalPnl">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Win Rate</div>
                <div class="stat-value accent" id="winRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Trades</div>
                <div class="stat-value" id="tradeCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Wins</div>
                <div class="stat-value profit" id="wins">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Losses</div>
                <div class="stat-value loss" id="losses">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Trades</div>
                <div class="stat-value accent" id="activeTrades">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Symbols</div>
                <div class="stat-value" id="symbolCount">10</div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Symbols Panel -->
            <div class="symbols-panel">
                <div class="panel-header">
                    <h3>üìä Live Symbols</h3>
                    <span class="badge" id="volatilityBadge">By Volatility</span>
                </div>
                <div class="symbols-list" id="symbolsList">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Active Trades -->
            <div class="trades-panel">
                <div class="panel-header">
                    <h3>üî• Active Trades</h3>
                    <span class="badge" id="activeCount">0 Open</span>
                </div>
                <div class="active-trades-grid" id="activeTradesGrid">
                    <div class="no-trades">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <p>No active trades</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Controls -->
                <div class="controls">
                    <div class="panel-header">
                        <h3>‚öôÔ∏è Settings</h3>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Balance ($)</label>
                            <input type="number" id="balanceInput" value="100" min="10">
                        </div>
                        <div class="control-group">
                            <label>Symbols</label>
                            <select id="symbolCountInput">
                                <option value="5">Top 5</option>
                                <option value="10" selected>Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>Profit Target (%)</label>
                            <input type="number" id="profitInput" value="0.05" step="0.01" min="0.01">
                        </div>
                        <div class="control-group">
                            <label>Stop Loss (%)</label>
                            <input type="number" id="stopInput" value="0.1" step="0.01" min="0.01">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group full">
                            <label>Max Trades Per Symbol</label>
                            <input type="number" id="maxTradesInput" value="10" min="1">
                        </div>
                    </div>
                    <button class="btn btn-start" id="startBtn" onclick="startBot()">‚ñ∂ Start Trading</button>
                </div>

                <!-- Trade History -->
                <div class="trade-history">
                    <div class="panel-header">
                        <h3>üìú History</h3>
                    </div>
                    <div class="trades-scroll" id="tradesScroll">
                        <div class="no-trades">
                            <p>No completed trades</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log -->
        <div class="log-panel">
            <div class="panel-header">
                <h3>üìù Activity Log</h3>
            </div>
            <div class="log-entries" id="logEntries"></div>
        </div>
    </div>

    <script>
        // Theme
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
            document.documentElement.classList.add('light');
        }
        window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', e => {
            document.documentElement.classList.toggle('light', e.matches);
        });

        // State
        const state = {
            running: false,
            symbols: [],
            websockets: {},
            prices: {},
            priceChanges: {},
            trades: {},
            completedTrades: [],
            balance: 100,
            startingBalance: 100,
            profitTarget: 0.05,
            stopLoss: 0.1,
            maxTradesPerSymbol: 10,
            tradeCountPerSymbol: {},
            totalPnl: 0,
            wins: 0,
            losses: 0
        };

        // DOM
        const dom = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            statusBadge: document.getElementById('statusBadge'),
            statusText: document.getElementById('statusText'),
            balance: document.getElementById('balance'),
            totalPnl: document.getElementById('totalPnl'),
            winRate: document.getElementById('winRate'),
            tradeCount: document.getElementById('tradeCount'),
            wins: document.getElementById('wins'),
            losses: document.getElementById('losses'),
            activeTrades: document.getElementById('activeTrades'),
            symbolCount: document.getElementById('symbolCount'),
            symbolsList: document.getElementById('symbolsList'),
            activeTradesGrid: document.getElementById('activeTradesGrid'),
            activeCount: document.getElementById('activeCount'),
            tradesScroll: document.getElementById('tradesScroll'),
            logEntries: document.getElementById('logEntries'),
            startBtn: document.getElementById('startBtn')
        };

        // Utilities
        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="time">[${time}]</span> ${msg}`;
            dom.logEntries.appendChild(entry);
            dom.logEntries.scrollTop = dom.logEntries.scrollHeight;
        }

        function formatPrice(price) {
            if (price >= 1000) return price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (price >= 1) return price.toFixed(4);
            return price.toFixed(6);
        }

        // Fetch top volatile symbols
        async function fetchVolatileSymbols(count) {
            dom.loadingText.textContent = 'Fetching market data...';

            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                const data = await response.json();

                // Filter USDT pairs with good volume and calculate volatility
                const usdtPairs = data
                    .filter(t => t.symbol.endsWith('USDT') && parseFloat(t.quoteVolume) > 10000000)
                    .map(t => ({
                        symbol: t.symbol,
                        price: parseFloat(t.lastPrice),
                        priceChange: parseFloat(t.priceChangePercent),
                        volume: parseFloat(t.quoteVolume),
                        high: parseFloat(t.highPrice),
                        low: parseFloat(t.lowPrice),
                        volatility: ((parseFloat(t.highPrice) - parseFloat(t.lowPrice)) / parseFloat(t.lowPrice)) * 100
                    }))
                    .filter(t => !t.symbol.includes('UP') && !t.symbol.includes('DOWN') && !t.symbol.includes('BULL') && !t.symbol.includes('BEAR'))
                    .sort((a, b) => b.volatility - a.volatility)
                    .slice(0, count);

                return usdtPairs;
            } catch (error) {
                log('Failed to fetch market data: ' + error.message, 'error');
                // Fallback to popular volatile pairs
                return [
                    { symbol: 'BTCUSDT', volatility: 0 },
                    { symbol: 'ETHUSDT', volatility: 0 },
                    { symbol: 'SOLUSDT', volatility: 0 },
                    { symbol: 'XRPUSDT', volatility: 0 },
                    { symbol: 'DOGEUSDT', volatility: 0 },
                    { symbol: 'ADAUSDT', volatility: 0 },
                    { symbol: 'AVAXUSDT', volatility: 0 },
                    { symbol: 'SHIBUSDT', volatility: 0 },
                    { symbol: 'LINKUSDT', volatility: 0 },
                    { symbol: 'MATICUSDT', volatility: 0 }
                ].slice(0, count);
            }
        }

        // Render symbols list
        function renderSymbolsList() {
            dom.symbolsList.innerHTML = state.symbols.map(s => `
                <div class="symbol-item" id="symbol-${s.symbol}" data-symbol="${s.symbol}">
                    <div class="symbol-info">
                        <span class="symbol-name">${s.symbol.replace('USDT', '')}</span>
                        <span class="symbol-vol">Vol: ${s.volatility.toFixed(2)}%</span>
                    </div>
                    <div class="symbol-price">
                        <span class="price" id="price-${s.symbol}">$${formatPrice(s.price || 0)}</span>
                        <span class="change ${(s.priceChange || 0) >= 0 ? 'up' : 'down'}" id="change-${s.symbol}">
                            ${(s.priceChange || 0) >= 0 ? '+' : ''}${(s.priceChange || 0).toFixed(2)}%
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Update stats UI
        function updateStats() {
            dom.balance.textContent = `$${state.balance.toFixed(2)}`;

            const pnlClass = state.totalPnl >= 0 ? 'profit' : 'loss';
            dom.totalPnl.textContent = `${state.totalPnl >= 0 ? '+' : ''}$${state.totalPnl.toFixed(4)}`;
            dom.totalPnl.className = `stat-value ${pnlClass}`;

            const total = state.wins + state.losses;
            const winRate = total > 0 ? ((state.wins / total) * 100).toFixed(1) : 0;
            dom.winRate.textContent = `${winRate}%`;
            dom.tradeCount.textContent = total;
            dom.wins.textContent = state.wins;
            dom.losses.textContent = state.losses;

            const activeCount = Object.keys(state.trades).length;
            dom.activeTrades.textContent = activeCount;
            dom.activeCount.textContent = `${activeCount} Open`;
            dom.symbolCount.textContent = state.symbols.length;
        }

        // Render active trades
        function renderActiveTrades() {
            const trades = Object.values(state.trades);

            if (trades.length === 0) {
                dom.activeTradesGrid.innerHTML = `
                    <div class="no-trades">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <p>No active trades</p>
                    </div>
                `;
                return;
            }

            dom.activeTradesGrid.innerHTML = trades.map(t => {
                const currentPrice = state.prices[t.symbol] || t.entryPrice;
                const pnl = (currentPrice - t.entryPrice) * t.quantity;
                const pnlPct = ((currentPrice - t.entryPrice) / t.entryPrice) * 100;
                const pnlClass = pnl >= 0 ? 'profit' : 'loss';

                // Progress bar
                const range = state.stopLoss + state.profitTarget;
                const normalized = (pnlPct + state.stopLoss) / range;
                const progressWidth = Math.max(0, Math.min(100, normalized * 100));

                return `
                    <div class="trade-card ${pnlClass}">
                        <div class="trade-card-header">
                            <span class="trade-symbol">${t.symbol.replace('USDT', '')}/USDT</span>
                            <span class="trade-pnl ${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(4)}</span>
                        </div>
                        <div class="trade-details-grid">
                            <div class="trade-detail">
                                <label>Entry</label>
                                <value>$${formatPrice(t.entryPrice)}</value>
                            </div>
                            <div class="trade-detail">
                                <label>Current</label>
                                <value>$${formatPrice(currentPrice)}</value>
                            </div>
                            <div class="trade-detail">
                                <label>Target</label>
                                <value>$${formatPrice(t.targetPrice)}</value>
                            </div>
                            <div class="trade-detail">
                                <label>Stop</label>
                                <value>$${formatPrice(t.stopPrice)}</value>
                            </div>
                        </div>
                        <div class="trade-progress">
                            <div class="trade-progress-fill ${pnlClass}" style="width: ${progressWidth}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add trade to history
        function addToHistory(trade) {
            if (dom.tradesScroll.querySelector('.no-trades')) {
                dom.tradesScroll.innerHTML = '';
            }

            const duration = ((trade.exitTime - trade.entryTime) / 1000).toFixed(1);
            const pnlPct = ((trade.pnl / (trade.entryPrice * trade.quantity)) * 100).toFixed(3);
            const winClass = trade.pnl >= 0 ? 'win' : 'loss';

            const item = document.createElement('div');
            item.className = `history-item ${winClass}`;
            item.innerHTML = `
                <div class="history-left">
                    <span class="history-symbol">${trade.symbol.replace('USDT', '')}</span>
                    <div class="history-info">
                        <span class="num">#${state.completedTrades.length}</span>
                        <span class="time">${new Date(trade.exitTime).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="history-right">
                    <span class="history-pnl ${trade.pnl >= 0 ? 'profit' : 'loss'}">${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(4)}</span>
                    <span class="history-duration">${duration}s ‚Ä¢ ${pnlPct}%</span>
                </div>
            `;

            dom.tradesScroll.insertBefore(item, dom.tradesScroll.firstChild);
        }

        // Trading logic
        function openTrade(symbol) {
            if (!state.running) return;
            if (state.trades[symbol]) return; // Already have a trade
            if ((state.tradeCountPerSymbol[symbol] || 0) >= state.maxTradesPerSymbol) return;

            const price = state.prices[symbol];
            if (!price) return;

            // Allocate balance per symbol (divide by active symbols)
            const perSymbolBalance = state.balance / state.symbols.length;
            const tradeAmount = perSymbolBalance * 0.9;

            if (tradeAmount < 1) return;

            const quantity = tradeAmount / price;
            const targetPrice = price * (1 + state.profitTarget / 100);
            const stopPrice = price * (1 - state.stopLoss / 100);

            state.trades[symbol] = {
                symbol,
                entryPrice: price,
                quantity,
                targetPrice,
                stopPrice,
                entryTime: Date.now()
            };

            state.tradeCountPerSymbol[symbol] = (state.tradeCountPerSymbol[symbol] || 0) + 1;

            // Update symbol item
            const symEl = document.getElementById(`symbol-${symbol}`);
            if (symEl) symEl.classList.add('has-trade');

            log(`OPEN ${symbol.replace('USDT', '')} @ $${formatPrice(price)}`, 'trade');
            renderActiveTrades();
            updateStats();
        }

        function checkExitConditions(symbol) {
            const trade = state.trades[symbol];
            if (!trade) return;

            const currentPrice = state.prices[symbol];
            if (!currentPrice) return;

            const pnlPct = ((currentPrice - trade.entryPrice) / trade.entryPrice) * 100;

            if (pnlPct >= state.profitTarget) {
                closeTrade(symbol, 'TARGET');
            } else if (pnlPct <= -state.stopLoss) {
                closeTrade(symbol, 'STOP');
            }
        }

        function closeTrade(symbol, reason) {
            const trade = state.trades[symbol];
            if (!trade) return;

            const exitPrice = state.prices[symbol];
            trade.exitPrice = exitPrice;
            trade.exitTime = Date.now();
            trade.pnl = (exitPrice - trade.entryPrice) * trade.quantity;

            state.balance += trade.pnl;
            state.totalPnl += trade.pnl;

            if (trade.pnl >= 0) {
                state.wins++;
                log(`‚úì ${symbol.replace('USDT', '')} +$${trade.pnl.toFixed(4)} (${reason})`, 'success');
            } else {
                state.losses++;
                log(`‚úó ${symbol.replace('USDT', '')} -$${Math.abs(trade.pnl).toFixed(4)} (${reason})`, 'error');
            }

            state.completedTrades.push(trade);
            addToHistory(trade);

            delete state.trades[symbol];

            // Update symbol item
            const symEl = document.getElementById(`symbol-${symbol}`);
            if (symEl) symEl.classList.remove('has-trade');

            renderActiveTrades();
            updateStats();
        }

        // WebSocket management
        function connectSymbol(symbol) {
            const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol.toLowerCase()}@trade`);

            ws.onopen = () => {
                const symEl = document.getElementById(`symbol-${symbol}`);
                if (symEl) symEl.classList.add('active');
            };

            ws.onmessage = (e) => {
                if (!state.running) return;

                const data = JSON.parse(e.data);
                const price = parseFloat(data.p);
                const oldPrice = state.prices[symbol];

                state.prices[symbol] = price;

                // Update price display
                const priceEl = document.getElementById(`price-${symbol}`);
                if (priceEl) priceEl.textContent = `$${formatPrice(price)}`;

                if (oldPrice) {
                    const change = ((price - oldPrice) / oldPrice) * 100;
                    state.priceChanges[symbol] = (state.priceChanges[symbol] || 0) + change;
                }

                // Trading logic
                if (state.trades[symbol]) {
                    checkExitConditions(symbol);
                    renderActiveTrades();
                } else {
                    openTrade(symbol);
                }
            };

            ws.onerror = () => {
                log(`WebSocket error: ${symbol}`, 'error');
            };

            ws.onclose = () => {
                const symEl = document.getElementById(`symbol-${symbol}`);
                if (symEl) symEl.classList.remove('active');
            };

            state.websockets[symbol] = ws;
        }

        function disconnectAll() {
            Object.values(state.websockets).forEach(ws => ws.close());
            state.websockets = {};
        }

        // Controls
        async function startBot() {
            // Get settings
            state.startingBalance = parseFloat(document.getElementById('balanceInput').value);
            state.balance = state.startingBalance;
            state.profitTarget = parseFloat(document.getElementById('profitInput').value);
            state.stopLoss = parseFloat(document.getElementById('stopInput').value);
            state.maxTradesPerSymbol = parseInt(document.getElementById('maxTradesInput').value);
            const symbolCount = parseInt(document.getElementById('symbolCountInput').value);

            // Reset state
            state.trades = {};
            state.completedTrades = [];
            state.tradeCountPerSymbol = {};
            state.totalPnl = 0;
            state.wins = 0;
            state.losses = 0;
            state.prices = {};

            dom.tradesScroll.innerHTML = '<div class="no-trades"><p>No completed trades</p></div>';

            // Fetch symbols
            dom.loadingOverlay.classList.remove('hidden');
            state.symbols = await fetchVolatileSymbols(symbolCount);
            renderSymbolsList();
            dom.loadingOverlay.classList.add('hidden');

            // Start
            state.running = true;
            dom.statusBadge.classList.add('connected', 'running');
            dom.statusText.textContent = 'Trading';
            dom.startBtn.textContent = '‚èπ Stop Trading';
            dom.startBtn.className = 'btn btn-stop';
            dom.startBtn.onclick = stopBot;

            // Disable inputs
            document.querySelectorAll('.controls input, .controls select').forEach(i => i.disabled = true);

            log(`Started trading ${state.symbols.length} symbols | Balance: $${state.balance} | Target: ${state.profitTarget}% | Stop: ${state.stopLoss}%`, 'success');

            // Connect to all symbols
            state.symbols.forEach(s => connectSymbol(s.symbol));

            updateStats();
        }

        function stopBot() {
            state.running = false;
            disconnectAll();

            // Close all open trades at current prices
            Object.keys(state.trades).forEach(symbol => {
                closeTrade(symbol, 'MANUAL');
            });

            dom.statusBadge.classList.remove('running');
            dom.statusText.textContent = 'Stopped';
            dom.startBtn.textContent = '‚ñ∂ Start Trading';
            dom.startBtn.className = 'btn btn-start';
            dom.startBtn.onclick = startBot;

            // Enable inputs
            document.querySelectorAll('.controls input, .controls select').forEach(i => i.disabled = false);

            const total = state.wins + state.losses;
            const winRate = total > 0 ? ((state.wins / total) * 100).toFixed(1) : 0;
            const returnPct = ((state.totalPnl / state.startingBalance) * 100).toFixed(3);

            log(`Stopped | Trades: ${total} | Win Rate: ${winRate}% | Return: ${returnPct}%`, 'warn');
        }

        // Initialize
        async function init() {
            const count = parseInt(document.getElementById('symbolCountInput').value);
            state.symbols = await fetchVolatileSymbols(count);
            renderSymbolsList();
            dom.loadingOverlay.classList.add('hidden');
            log('Dashboard ready - Click Start Trading to begin', 'info');
        }

        init();
    </script>
</body>
</html>

